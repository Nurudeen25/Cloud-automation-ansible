---
- name: Install nessesary package
  hosts: rmqsrvgrp
  gather_facts: no
  tasks:
    apt:
      name: apt-transport-https
      state: present
      update_cache: yes

- name: Download esl-erlang package
  get_url:
    url: https://packages.erlang-solutions.com/erlang/esl-erlang/FLAVOUR_1_general/esl-erlang_21.0-1~debian~stretch_amd64.deb
    dest: /home/admin/esl-erlang_21.0-1~debian~stretch_amd64.deb
    owner: admin
    group: admin
    mode: 0755

- name: Install esl-erlang
  apt:
    deb: /home/admin/esl-erlang_21.0-1~debian~stretch_amd64.deb

- name: Download erlang solutions
  get_url:
    url: https://packages.erlang-solutions.com/erlang-solutions_1.0_all.deb
    dest: /home/admin/erlang-solutions_1.0_all.deb
    owner: admin
    group: admin
    mode: 0755

- name: Install erlang repository
  apt:
    deb: /home/admin/erlang-solutions_1.0_all.deb

- name: Add an Apt signing key
  apt_key:
    url: https://packages.erlang-solutions.com/debian/erlang_solutions.asc
    state: present

- name: fix unmet dependencies
  shell: apt-get -f install

- name: Add rabbit repo
  shell: echo "deb https://dl.bintray.com/rabbitmq/debian stretch main" | tee /etc/apt/sources.list.d/bintray.rabbitmq.list

- name: add trusted key
  shell: wget -O- https://dl.bintray.com/rabbitmq/Keys/rabbitmq-release-signing-key.asc | apt-key add -

- name: install rabbitmq
  apt:
    name: rabbitmq-server
    state: present
    update_cache: yes

- name: enable rabbitmq plugins
  rabbitmq_plugin:
    names: rabbitmq_management
    state: enabled
  notify:
    - restart rabbitmq

- name: add rabbitmq users admin
  rabbitmq_user:
    user: test
    password: test
    vhost: /
    tags: administrator
    configure_priv: .*
    read_priv: .*
    write_priv: .*
    state: present

#---
#- name: Install & Setup RabbitMQ with user
#  hosts: rmqsrvgrp
#  gather_facts: no
#  tasks:
#    - name: Install Erlang Repository Package
#      apt:
#        deb: https://packages.erlang-solutions.com/erlang-solutions_1.0_all.deb
#      tags:
#        - package
#
#    - name: Add an Erlang Solution public Key
#      apt_key:
#        url: https://packages.erlang-solutions.com/ubuntu/erlang_solutions.asc
#        state: present
#      tags:
#        - package
#
#    - name: Install Erlang
#      apt:
#        name: erlang
#        update_cache: yes
#        cache_valid_time: 86400
#        state: present
#      tags:
#        - package
#
#    - name: Add an Apt signing key, uses whichever key is at the URL
#      apt_key:
#        url: https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc
#        state: present
#      tags:
#        - package
#
#    - apt_repository:
#        repo: deb https://dl.bintray.com/rabbitmq/debian bionic main
#        state: present
#      tags:
#        - package
#
#    - name: Install Rabbit MQ
#      apt:
#        name: rabbitmq-server
#        state: present
#        update_cache: yes
#      tags:
#        - package
#
#
#    - name: Start & Enable RMQ
#      service:
#        name: rabbitmq-server
#        state: started
#        enabled: yes
#      tags:
#        - svc
#
#    - name: Config setup
#      copy:
#        content: |
#          [{rabbit, [{loopback_users, []}]}].
#        dest: /etc/rabbitmq/rabbitmq.config
#      notify:
#        - Restart RMQ
#      tags:
#        - conf
#
#
#    - rabbitmq_user:
#        user: test
#        password: test
#        configure_priv: .*
#        read_priv: .*
#        write_priv: .*
#        tags: administrator
#        state: present
#      notify:
#        - Restart RMQ
#      tags:
#        - conf
#
#
#    - name: Enables the rabbitmq_management plugin
#      rabbitmq_plugin:
#        names: rabbitmq_management
#        state: enabled
#      notify:
#        - Restart RMQ
#      tags:
#        - package
#
#  handlers:
#    - name: Restart RMQ
#      service:
#        name: rabbitmq-server
#        state: restarted